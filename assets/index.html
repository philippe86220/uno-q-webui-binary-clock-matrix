<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>UNO Q Binary Clock</title>

<style>
:root{ --scale: 1.2; }

body {
  font-family: system-ui, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: calc(30px * var(--scale));
}

h2 {
  margin-bottom: calc(10px * var(--scale));
  font-size: calc(24px * var(--scale));
}

.controls { margin-bottom: calc(20px * var(--scale)); }

button {
  padding: calc(10px * var(--scale)) calc(18px * var(--scale));
  margin-right: calc(10px * var(--scale));
  border: none;
  border-radius: calc(8px * var(--scale));
  background: #1e293b;
  color: white;
  cursor: pointer;
  font-size: calc(15px * var(--scale));
  transition: 0.2s;
}

button:hover { background: #334155; }

#timeText {
  font-size: calc(34px * var(--scale));
  letter-spacing: calc(2px * var(--scale));
  margin: calc(20px * var(--scale)) 0 calc(16px * var(--scale)) 0;
  color: #22c55e;
  font-weight: bold;
}

.clockWrap{
  display: flex;
  align-items: flex-start;
  gap: calc(16px * var(--scale));
  margin-top: calc(18px * var(--scale));
}

.weights{
  display: grid;
  grid-template-rows: repeat(4, calc(28px * var(--scale)));
  gap: calc(10px * var(--scale));
  margin-top: calc(2px * var(--scale));
  color: #94a3b8;
  font-weight: 600;
  font-size: calc(14px * var(--scale));
  line-height: calc(28px * var(--scale));
  text-align: right;
  width: calc(20px * var(--scale));
}

.row {
  display: flex;
  gap: calc(24px * var(--scale));
  align-items: flex-start;
}

.digit {
  display: grid;
  grid-template-rows: repeat(4, calc(28px * var(--scale)));
  gap: calc(10px * var(--scale));
}

.led {
  width: calc(28px * var(--scale));
  height: calc(28px * var(--scale));
  border-radius: calc(6px * var(--scale));
  background: #020617;
  border: calc(2px * var(--scale)) solid #1e293b;
  transition: 0.2s;
}

.led.on {
  background: #22c55e;
  box-shadow:
    0 0 calc(8px * var(--scale)) #22c55e,
    0 0 calc(18px * var(--scale)) #22c55e;
}

/* Unit digits (H units, M units, S units) in red */
.unitDigit .led.on {
  background: #ef4444;
  box-shadow:
    0 0 calc(8px * var(--scale)) #ef4444,
    0 0 calc(18px * var(--scale)) #ef4444;
}

.sep { width: calc(12px * var(--scale)); }

.tzPanel{
  margin-top: calc(14px * var(--scale));
  padding: calc(14px * var(--scale));
  border: 1px solid #1e293b;
  border-radius: calc(10px * var(--scale));
  background: rgba(2,6,23,0.35);
  max-width: calc(980px * var(--scale));
}

.tzTitle{
  font-weight: 700;
  margin-bottom: calc(10px * var(--scale));
  color: #cbd5e1;
  display:flex;
  align-items:center;
  gap: calc(10px * var(--scale));
  flex-wrap: wrap;
}

.badge{
  display: inline-block;
  padding: calc(3px * var(--scale)) calc(10px * var(--scale));
  border-radius: 999px;
  background: #1e293b;
  color: #e5e7eb;
  font-size: calc(12px * var(--scale));
}

.tzRow{
  display:flex;
  gap: calc(10px * var(--scale));
  flex-wrap:wrap;
  align-items:center;
}

.tzRow input{
  padding: calc(10px * var(--scale));
  border-radius: calc(8px * var(--scale));
  border: 1px solid #334155;
  background: #0b1220;
  color: #e5e7eb;
  min-width: calc(320px * var(--scale));
  font-size: calc(14px * var(--scale));
  outline:none;
}

.tzMeta{
  margin-top: calc(10px * var(--scale));
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  color: #94a3b8;
  font-size: calc(13px * var(--scale));
}

.tzMsg{
  margin-top: calc(8px * var(--scale));
  font-size: calc(14px * var(--scale));
}

.footer {
  margin-top: calc(40px * var(--scale));
  color: #64748b;
  font-size: calc(14px * var(--scale));
}
</style>
</head>

<body>

<h2>Binary Clock (BCD)</h2>

<div class="controls">
  <button id="startBtn">Resume Matrix</button>
  <button id="stopBtn">Sleep Matrix</button>
</div>

<div id="timeText">--:--:-- -- -- ----</div>

<div class="tzPanel">
  <div class="tzTitle">
    Timezone
    <span class="badge" id="tzBadge">loading</span>
    <span class="badge" id="runBadge">running?</span>
    <button id="fmtBtn">24h</button>
  </div>

  <div class="tzRow">
    <input id="tzInput" type="text" placeholder="Europe/Paris or Asia/Dhaka">
    <button id="tzApplyBtn">Apply</button>
    <button id="tzDetectBtn">Detect my timezone</button>
    <button id="tzReloadBtn">Reload</button>
  </div>

  <div class="tzMeta" id="tzMeta">Current timezone: (loading)</div>
  <div class="tzMsg" id="tzMsg"></div>
</div>

<div class="clockWrap">
  <div class="weights">
    <div>8</div><div>4</div><div>2</div><div>1</div>
  </div>
  <div class="row" id="clock"></div>
</div>

<div class="footer">
UNO Q · Linux time source · WebUI Binary Clock
</div>

<script>
(function(){
  "use strict";

  function qs(id){ return document.getElementById(id); }

  // 12h/24h toggle (WebUI only)
  let use12h = (localStorage.getItem("clock12h") === "1");
  function updateFmtBtn(){
    qs("fmtBtn").textContent = use12h ? "12h" : "24h";
  }
  updateFmtBtn();
  qs("fmtBtn").onclick = () => {
    use12h = !use12h;
    localStorage.setItem("clock12h", use12h ? "1" : "0");
    updateFmtBtn();
  };

  function makeDigit() {
    const d = document.createElement("div");
    d.className = "digit";
    for (let i = 0; i < 4; i++) {
      const led = document.createElement("div");
      led.className = "led";
      d.appendChild(led);
    }
    return d;
  }

  function setDigitBCD(digitEl, value) {
    const leds = digitEl.querySelectorAll(".led");
    for (let i = 0; i < 4; i++) {
      const bit = 1 << (3 - i);
      leds[i].className = "led" + ((value & bit) ? " on" : "");
    }
  }

  const clockEl = qs("clock");
  const digits = [];

  for (let i = 0; i < 6; i++) {
    const d = makeDigit();
    if (i === 1 || i === 3 || i === 5) d.classList.add("unitDigit");
    digits.push(d);
    clockEl.appendChild(d);

    if (i === 1 || i === 3) {
      const sep = document.createElement("div");
      sep.className = "sep";
      clockEl.appendChild(sep);
    }
  }

  function setTzMsg(text, ok) {
    const el = qs("tzMsg");
    el.textContent = text || "";
    el.style.color = ok ? "#86efac" : "#fca5a5";
  }

  function setBadge(el, text, ok) {
    el.textContent = text;
    el.style.background = ok ? "#064e3b" : "#7f1d1d";
  }

  async function apiGetTime(){
    const r = await fetch("/api/time", { method:"GET" });
    if(!r.ok) throw new Error("GET /api/time failed: " + r.status);
    return await r.json();
  }

  async function apiPost(path){
    const r = await fetch(path, { method:"POST" });
    if(!r.ok) throw new Error("POST " + path + " failed: " + r.status);
    return await r.text();
  }

  async function apiGetTimezone(){
    const r = await fetch("/api/timezone", { method:"GET" });
    if(!r.ok) throw new Error("GET /api/timezone failed: " + r.status);
    return await r.json();
  }

  async function apiSetTimezone(tz) {
    const url = "/api/timezone?timezone=" + encodeURIComponent(tz);
    const r = await fetch(url, { method: "POST" });
    if (!r.ok) throw new Error("POST /api/timezone failed: " + r.status);
    return await r.json();
  }

  function formatDateInline(y, mo, d){
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    if(!y || !mo || !d) return "-- -- ----";
    const name = months[mo - 1] || "??";
    return String(d).padStart(2,"0") + " " + name + " " + String(y);
  }

  function formatTimeInline(h, m, s){
    if(!use12h){
      return String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    }

    let hh = h;
    const suffix = (hh >= 12) ? " PM" : " AM";
    hh = hh % 12;
    if (hh === 0) hh = 12;

    return String(hh).padStart(2,"0") + ":" + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0") + suffix;
  }

  async function tick(){
    try{
      const t = await apiGetTime();
      const h = t.h, m = t.m, s = t.s;

      const timePart = formatTimeInline(h, m, s);
      const datePart = formatDateInline(t.y, t.mo, t.d);

      qs("timeText").textContent = timePart + " " + datePart;

      // BCD stays 24h (matrix and BCD reflect raw h/m/s)
      const vals = [
        Math.floor(h/10), h%10,
        Math.floor(m/10), m%10,
        Math.floor(s/10), s%10
      ];
      for (let i = 0; i < 6; i++) setDigitBCD(digits[i], vals[i]);

      setBadge(qs("runBadge"), t.running ? "matrix: on" : "matrix: sleep", true);

    }catch(e){
      qs("timeText").textContent = "API error";
    }
  }

  async function refreshTimezoneUI(){
    try{
      const data = await apiGetTimezone();
      const tz = data.timezone || "UTC";
      qs("tzMeta").textContent = "Current timezone: " + tz;
      qs("tzInput").value = tz;
      setBadge(qs("tzBadge"), tz, true);
      setTzMsg("", true);
    }catch(e){
      qs("tzMeta").textContent = "Current timezone: (error)";
      setBadge(qs("tzBadge"), "error", false);
      setTzMsg(String(e), false);
    }
  }

  async function applyTimezone(){
    const tz = (qs("tzInput").value || "").trim();
    if(!tz){
      setTzMsg("Please enter a timezone like Asia/Dhaka or Europe/Paris", false);
      return;
    }
    try{
      const res = await apiSetTimezone(tz);
      if(res && res.ok){
        setTzMsg("Saved timezone: " + (res.timezone || tz), true);
        await refreshTimezoneUI();
      }else{
        setTzMsg((res && res.error) ? res.error : "Server refused timezone", false);
      }
    }catch(e){
      setTzMsg(String(e), false);
    }
  }

  async function detectMyTimezone(){
    try{
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if(!tz){
        setTzMsg("Timezone detection failed. Please type it manually.", false);
        return;
      }
      qs("tzInput").value = tz;
      await applyTimezone();
    }catch(e){
      setTzMsg(String(e), false);
    }
  }

  function updateScale() {
    const target = 1100;
    const s = Math.min(1.5, Math.max(0.8, window.innerWidth / target));
    document.documentElement.style.setProperty("--scale", String(s));
  }

  try{
    qs("startBtn").onclick = () => apiPost("/api/start").catch(()=>{});
    qs("stopBtn").onclick  = () => apiPost("/api/stop").catch(()=>{});

    qs("tzApplyBtn").onclick  = () => applyTimezone();
    qs("tzDetectBtn").onclick = () => detectMyTimezone();
    qs("tzReloadBtn").onclick = () => refreshTimezoneUI();

    qs("tzInput").addEventListener("keydown", (ev)=>{
      if(ev.key === "Enter") applyTimezone();
    });
  }catch(e){
    // ignore
  }

  window.addEventListener("resize", updateScale);
  updateScale();

  refreshTimezoneUI();
  tick();
  setInterval(tick, 1000);

})();
</script>

</body>
</html>
